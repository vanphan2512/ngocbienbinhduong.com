
var MWPSkype=MWPSkype||{};
MWPSkype.buttons=new function(){var self=this,commands={},usernames={};
self.config={commands:"*",size:14,status:"off",theme:"logo",language:"en",bgcolor:"#2a92f3"};
var Languages={en:{online:"Online",away:"Away",busy:"Do Not Disturb",offline:"Offline",unknown:"Unknown",status_title:"Status",cmd_chat:"Chat",cmd_call:"Call",cmd_videocall:"Videocall",cmd_voicemail:"voicemail",cmd_add:"add",cmd_userinfo:"userinfo",cmd_sendfile:"sendfile"}};
function parseConfig(node){var config={};
if(node.getAttribute("data-config")){for(var i=0,groups=node.getAttribute("data-config").split(";");i<groups.length;i++){var parts=groups[i].split("="),key=parts[0],val=parts[1];if(key&&val){config[key]=val}}}return config}
function mergeConfigs(primary,defaults){
var config=primary;
for(var key in defaults){
if(config[key]===undefined){
config[key]=defaults[key]
}
}
return config}
function byid(id){return document.getElementById(id)}
function lang(key,iso){if(!iso){
var iso=self.config.language}
if(Languages[iso]){
return Languages[iso][key]}
else{console.log("MWPSkype.buttons missing language string: "+key,iso)}
}
function defineLangHost(link){
self.config.language='en';
return(self.config.language in Languages)
}
function getGlobalConfig(){
var homelink=byid("mwp-skype-buttons-<?php echo $val->id ;?>");
return mergeConfigs(parseConfig(homelink),self.config)
}
function shadeColor(color,percent){var num=parseInt(color.slice(1),16),amt=Math.round(2.55*percent),R=(num>>16)+amt,G=(num>>8&255)+amt,B=(num&255)+amt,val="#"+(16777216+(R<255?R<1?0:R:255)*65536+(G<255?G<1?0:G:255)*256+(B<255?B<1?0:B:255)).toString(16).slice(1);if(val===color){return shadeColor(color,-percent)}else{return val}}
function includeStylesheet(globalConfig){var css="@class-wrapper{position:relative;clear:both;text-align:left}@class-icon{display:inline-block;background-position:left center;background-repeat:no-repeat;vertical-align:middle;margin-top:-2px;margin-right:3px}@class-status-skype @class-icon{background-position:0 0}@class-size-14 @class-icon{height:14px;width:14px}@class-size-22 @class-icon{height:22px;width:22px}@class-size-30 @class-icon{width:30px;height:30px}@class-theme-logo@class-size-14 @class-icon{background-image:url(%uri%/sk/14.png)}@class-theme-logo@class-size-22 @class-icon{background-image:url(%uri%/sk/22.png)}@class-theme-logo@class-size-30 @class-icon{background-image:url(%uri%/sk/30.png)}@class-size-14 @class-status-online @class-icon{background-position:0 -14px}@class-size-14 @class-status-away @class-icon{background-position:0 -28px}@class-size-14 @class-status-busy @class-icon{background-position:0 -42px}@class-size-14 @class-status-offline @class-icon{background-position:0 -56px}@class-size-14 @class-status-unknown @class-icon{background-position:0 -70px}@class-size-22 @class-status-online @class-icon{background-position:0 -22px}@class-size-22 @class-status-away @class-icon{background-position:0 -44px}@class-size-22 @class-status-busy @class-icon{background-position:0 -66px}@class-size-22 @class-status-offline @class-icon{background-position:0 -88px}@class-size-22 @class-status-unknown @class-icon{background-position:0 -110px}@class-size-30 @class-status-online @class-icon{background-position:0 -30px}@class-size-30 @class-status-away @class-icon{background-position:0 -60px}@class-size-30 @class-status-busy @class-icon{background-position:0 -90px}@class-size-30 @class-status-offline @class-icon{background-position:0 -120px}@class-size-30 @class-status-unknown @class-icon{background-position:0 -150px}@class-arrow{display:inline-block;font-family:monospace;font-size:14px;margin-left:0;padding:0;font-weight:normal}@class-container{background-color:"+globalConfig.bgcolor+";display:none;position:absolute;margin-top:15px;z-index:9999;line-height:18px;top:18px}@class-size-14 @class-container{left:16px}@class-size-22 @class-container{left:24px}@class-size-30 @class-container{left:32px}@class-container a{text-decoration:none;padding:4px 7px 4px 25px;display:block;white-space:pre;border:none;border-bottom:1px solid "+shadeColor(globalConfig.bgcolor,10)+";background-position:4px center;background-repeat:no-repeat}@class-container a,@class-container a:visited,@class-container a:link,@class-container a:active{color:#fff;font-size:12px;font-family:Verdana;line-height:18px}@class-container a:hover{background-color:"+shadeColor(globalConfig.bgcolor,-10)+"}@class-cmd-chat{background-image:url(%uri%/sk/chat.png)}@class-cmd-call{background-image:url(%uri%/sk/call.png)}@class-cmd-videocall{background-image:url(%uri%/sk/videocall.png)}@class-cmd-voicemail{background-image:url(%uri%/sk/voicemail.png)}@class-cmd-add{background-image:url(%uri%/sk/add.png)}@class-cmd-userinfo{background-image:url(%uri%/sk/userinfo.png)}@class-cmd-sendfile{background-image:url(%uri%/sk/sendfile.png)}";var style=createUniqNode("style","css");style.type="text/css";style.innerHTML=setAppUri(css.replace(/@class/g,".mwp-skype-buttons"));var node=document.getElementsByTagName("head");node=(node.length)?node[0]:document.body;node.appendChild(style)}
function setAppUri(str){return str.replace(/%uri%/g,"<?php echo plugins_url('', __FILE__) ;?>")}
function skypeLink(username,cmd){var link=document.createElement("a");link.href=skypeUri(username,cmd.uri);link.className="mwp-skype-buttons-cmd-"+cmd.name;link.setAttribute("data-mwp-skype-buttons","off");link.innerHTML=cmd.text;return link}
function skypeUri(username,cmduri){var uri="skype:"+username;if(cmduri){uri+="?"+cmduri}return uri}
function addEvent(elem,type,handler){if(elem.addEventListener){elem.addEventListener(type,handler,false)}else{elem.attachEvent("on"+type,handler)}}
function createUniqNode(tag,name){var id="mwp-skype-buttons-uniqnode-"+name,oldNode=byid(id);if(oldNode){oldNode.parentNode.removeChild(oldNode)}var newNode=document.createElement(tag);newNode.id=id;return newNode}
function jsonpRequest(username){MWPSkype.buttons.setStatus(username,"online")}
function displayStatus(link,config){if(config.username[0]!=="+"){if(!usernames[config.username]){usernames[config.username]={name:"unknown",links:[]};setTimeout(function(){jsonpRequest(config.username)},500)}usernames[config.username].links.push(link);changeStatus(link,"unknown")}}
function changeStatus(link,status){link.setAttribute("class","mwp-skype-buttons-status-"+status);var status_title=lang(status,link.config.language);if(status_title){var status_lang=lang("status_title",link.config.language);link.setAttribute("title",status_lang+': "'+status_title+'"')}}
function dropDownArrow(){return'<span class="mwp-skype-buttons-arrow">&#x25BE;</span>'}
function createWrapper(link,config){var wrapper=document.createElement("span");if(link.nextSibling){link.parentNode.insertBefore(wrapper,link.nextSibling)}else{link.parentNode.appendChild(wrapper)}var classes=["mwp-skype-buttons-wrapper","mwp-skype-buttons-theme-"+config.theme,"mwp-skype-buttons-size-"+config.size];wrapper.setAttribute("class",classes.join(" "));wrapper.appendChild(link);return wrapper}
function commandsContainer(link,config){link.onclick=function(){return false};var container=document.createElement("span");container.className="mwp-skype-buttons-container";container.style.display="none";addEvent(document,"click",function(e){if(!e.target||(e.target!==link&&e.target.parentNode!==link)){container.style.display="none"}});addEvent(link,"click",function(){var display=(container.style.display==="none")?"inline-block":"none";container.style.display=display});var commands=self.getCommands(config.commands,config.language);for(var c=0;c<commands.length;c++){var cmd=skypeLink(config.username,commands[c]);container.appendChild(cmd)}link.href=skypeUri(config.username,commands[0].uri);if(commands.length>1){link.innerHTML+=dropDownArrow()}return container}
function parseSkypeUri(value){var parts=value.replace(/^skype:/ig,"").split("?"),uri={};if(parts.length===2&&parts[1].indexOf("blob=")!==-1){uri.value=parts[1].split("blob=")[1].split("&")[0];uri.type="blob"}else{uri.value=parts[0].split(";")[0].replace(/\s/g,"");uri.type=(parts[0].indexOf("+")===0)?"phone":"username"}return uri}
function setupLinkButton(link,globalConfig){var uri=parseSkypeUri(link.getAttribute("href"));if(uri.value){link.config=mergeConfigs(parseConfig(link),globalConfig);link.config.username=uri.value;link.innerHTML='<span class="mwp-skype-buttons-icon"></span>'+(link.innerHTML?link.innerHTML:link.config.username);link.setAttribute("data-mwp-skype-buttons","off");var wrapper=createWrapper(link,link.config);changeStatus(link,"skype");if(link.config.commands&&uri.type!=="blob"){wrapper.appendChild(commandsContainer(link,link.config,wrapper))}if(uri.type==="username"&&link.config.status==="on"){displayStatus(link,link.config)}}}
function setup(){var globalConfig=getGlobalConfig();if(globalConfig){var nodes=document.getElementsByTagName("a");if(nodes){var links=[];for(var i=0;i<nodes.length;i++){if(nodes[i].getAttribute("href")&&nodes[i].getAttribute("data-mwp-skype-buttons")!=="off"){var url=nodes[i].getAttribute("href");if(url.indexOf("skype:")===0){links.push(nodes[i])}}}if(links.length>0){includeStylesheet(globalConfig);for(var i=0;i<links.length;i++){setupLinkButton(links[i],globalConfig)}}}}}
function defineCommands(iso){if(!commands[iso]){commands[iso]=[{name:"chat",uri:"chat"},{name:"call",uri:"call"},{name:"videocall",uri:"call&video=true"},{name:"voicemail",uri:"voicemail"},{name:"add",uri:"add"},{name:"userinfo",uri:"userinfo"},{name:"sendfile",uri:"sendfile"}];for(var c=0;c<commands[iso].length;c++){commands[iso][c].text=lang("cmd_"+commands[iso][c].name,iso)}}return commands[iso]}this.getSizes=function(){return[14,22,30]};this.getThemes=function(){return["logo"]};this.getCommands=function(filter,iso){var cmds=defineCommands(iso);if(filter==="*"){return cmds}else{var result=[];for(var n=0,names=filter.split(",");n<names.length;n++){for(var c=0;c<cmds.length;c++){var cmd=cmds[c];if(cmd.name===names[n]){result.push(cmd)}}}return result}};this.setStatus=function(username,status,date){if(usernames[username]){for(var i=0;i<usernames[username].links.length;i++){changeStatus(usernames[username].links[i],status)}delete usernames[username]}};this.setup=setup;setup()};